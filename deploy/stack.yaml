# Example Docker Swarm stack for Warren-managed agents.
# Deploy with: docker stack deploy -c stack.yaml warren

version: "3.8"

# Encrypted overlay network for agent traffic.
# Warren routes to agents over this network using Swarm DNS:
#   http://tasks.<service-name>:<port>
# No published ports needed — all traffic stays on the overlay.
networks:
  agents:
    driver: overlay
    driver_opts:
      encrypted: "true"

# External secrets — create before deploying:
#   echo "secret-value" | docker secret create agent_api_key -
secrets:
  agent_api_key:
    external: true

services:
  # Hermes — NATS message bus with JetStream for inter-agent communication.
  hermes:
    image: nats:latest
    command: ["--jetstream", "--store_dir", "/data", "--http_port", "8222"]
    networks:
      - agents
    ports:
      - "4222:4222"   # NATS client (published for bare-metal orchestrator)
      - "8222:8222"   # HTTP monitoring
    volumes:
      - hermes-data:/data
    deploy:
      replicas: 1
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 10
        window: 120s
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

  # The Warren orchestrator itself.
  orchestrator:
    image: ghcr.io/your-org/warren:latest
    networks:
      - agents
    ports:
      - "8080:8080"
    configs:
      - source: orchestrator_config
        target: /etc/warren/orchestrator.yaml
    command: ["./orchestrator", "--config", "/etc/warren/orchestrator.yaml"]
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager  # needs access to Swarm API
    volumes:
      # Docker socket needs write access for Swarm service scaling (docker service update).
      # Read-only mount would prevent Warren from starting/stopping agent containers.
      # Security: access is limited to the overlay network; admin port is not publicly exposed.
      # Consider using a Docker socket proxy (e.g., tecnativa/docker-socket-proxy) for
      # fine-grained API access control in production.
      - /var/run/docker.sock:/var/run/docker.sock

  # Example always-on agent service.
  # Swarm maintains exactly 1 replica and restarts on failure.
  # Warren config backend: "http://tasks.warren_example-agent:8080"
  example-agent:
    image: ghcr.io/your-org/your-agent:latest
    networks:
      - agents
    # No published ports — Warren proxies traffic via the overlay network.
    # Reachable at: http://tasks.warren_example-agent:<port>

    deploy:
      replicas: 1
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 10
        window: 120s
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

    secrets:
      - agent_api_key
    environment:
      - AGENT_NAME=example

  # Example on-demand agent service.
  # Warren scales this between 0 and 1 replicas.
  # Warren config backend: "http://tasks.warren_on-demand-agent:8080"
  on-demand-agent:
    image: ghcr.io/your-org/your-on-demand-agent:latest
    networks:
      - agents

    deploy:
      replicas: 0  # Warren manages scaling
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
        window: 120s
      resources:
        limits:
          cpus: "1.0"
          memory: 1G

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

    environment:
      - AGENT_NAME=on-demand

volumes:
  hermes-data:
    driver: local

configs:
  orchestrator_config:
    file: ../configs/orchestrator.example.yaml
