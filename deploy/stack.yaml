version: "3.8"

networks:
  agents:
    driver: overlay
    driver_opts:
      encrypted: "true"

secrets:
  openclaw_gateway_token:
    external: true

volumes:
  hermes-data:

services:
  lily:
    image: openclaw-friend:latest
    networks:
      - agents
    ports:
      - "18790:18790"
    deploy:
      replicas: 1
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 10
        window: 120s
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    environment:
      - OPENCLAW_GATEWAY_TOKEN=password
      - FORGE_URL=http://warren_promptforge:8083
      - SOUL_SLUG=lily
      - GEMINI_API_KEY=AIzaSyCMnoSY8R0Pn9Y6AWaJuJmi8ITXM8x5H3A
      - OPENCLAW_GATEWAY_PORT=18790
      - OPENCLAW_MODEL=google/gemini-2.0-flash
      - OPENCLAW_PREFER_PNPM=1
      - NODE_ENV=production
    volumes:
      - /home/mike/openclaw-friend/friend-openclaw-data:/home/node/.openclaw
    command: ["/bin/sh", "/home/node/.openclaw/pull-soul-entrypoint.sh"]

  dutybound-mc:
    image: dutybound-mc:latest
    networks:
      - agents
    ports:
      - "8081:8081"
    deploy:
      replicas: 0
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 10
        window: 120s
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
        reservations:
          cpus: "0.5"
          memory: 1G
    secrets:
      - openclaw_gateway_token
    volumes:
      - /home/mike/MissionControl:/opt/mc

  hermes:
    image: nats:latest
    networks:
      - agents
    ports:
      - "4222:4222"
      - "8222:8222"
    command: ["--jetstream", "--store_dir", "/data", "--http_port", "8222"]
    volumes:
      - hermes-data:/data
    deploy:
      replicas: 1
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 10
        window: 120s
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  promptforge:
    image: promptforge:latest
    networks:
      - agents
    ports:
      - "8083:8083"
    deploy:
      replicas: 0
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
    environment:
      - SUPABASE_URL=https://uaubofpmokvumbqpeymz.supabase.co
      - SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhdWJvZnBtb2t2dW1icXBleW16Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDg0OTMyNywiZXhwIjoyMDg2NDI1MzI3fQ.vpS4LvCi80RZlfxZStGKL8Oti-0qo33eoC5-7RA-YAk
      - SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhdWJvZnBtb2t2dW1icXBleW16Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDg0OTMyNywiZXhwIjoyMDg2NDI1MzI3fQ.vpS4LvCi80RZlfxZStGKL8Oti-0qo33eoC5-7RA-YAk
      - PROMPT_FORGE_API_KEY=forge-api-868f36e0
      - NATS_URL=nats://warren_hermes:4222

  celebrimbor:
    image: openclaw-friend:latest
    networks:
      - agents
    ports:
      - "18791:18791"
    deploy:
      replicas: 0
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
        window: 120s
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
    environment:
      - OPENCLAW_GATEWAY_TOKEN=celebrimbor-forge-token
      - GEMINI_API_KEY=AIzaSyCMnoSY8R0Pn9Y6AWaJuJmi8ITXM8x5H3A
      - OPENCLAW_GATEWAY_PORT=18791
      - OPENCLAW_MODEL=google/gemini-2.0-flash
      - NODE_ENV=production
    volumes:
      - /home/mike/celebrimbor-data:/home/node/.openclaw
    command: ["node", "/app/openclaw.mjs", "gateway", "--bind", "lan", "--port", "18791", "--allow-unconfigured"]
